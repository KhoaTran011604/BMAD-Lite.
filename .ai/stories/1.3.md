# Story 1.3: RBAC Implementation

**Status:** Done
**Epic:** Epic 1 - Foundation & Authentication
**Created:** 2026-01-30
**Last Updated:** 2026-01-30

## Story

**As an** administrator,
**I want** to assign roles to users,
**so that** they have appropriate access to system features.

## Acceptance Criteria

1. Given 5 predefined roles (Super Admin, Diocese Manager, Parish Priest, Accountant, Parish Secretary), When I assign role to user, Then their permissions are updated
2. Given user with specific role, When they access sidebar, Then only permitted menu items are visible
3. Given user without permission, When they access restricted API route, Then they receive 403 Forbidden
4. Given user without permission, When they navigate to restricted URL, Then they're redirected to Dashboard with error

## Tasks

- [x] Task 1: Define Permission Constants and RBAC Utilities (AC: 1, 3)
  - [x] Create permission constants at `src/lib/auth/permissions.ts`
  - [x] Define all permission codes (users.*, parishes.*, transactions.*, etc.)
  - [x] Create role-to-permissions mapping for all 5 roles
  - [x] Create `hasPermission()` utility function
  - [x] Create `hasAnyPermission()` and `hasAllPermissions()` helpers

- [x] Task 2: Create RBAC Middleware for API Routes (AC: 3)
  - [x] Create `withPermission()` HOC at `src/lib/auth/rbac.ts`
  - [x] Integrate with existing auth session from Story 1.2
  - [x] Return 403 Forbidden with structured error response
  - [x] Support single permission and array of permissions
  - [x] Add role-based data filtering support (parish scoping)

- [x] Task 3: Create Permission-Based Sidebar Navigation (AC: 2)
  - [x] Update sidebar config with permission requirements per menu item
  - [x] Create `usePermissions()` hook to check user permissions
  - [x] Filter sidebar menu items based on user permissions
  - [x] Group menu items by category (Finance, HR, Administration, System)
  - [x] Add icons from Lucide React for each menu item

- [x] Task 4: Implement Client-Side Route Protection (AC: 4)
  - [x] Update proxy.ts to check permissions for protected routes
  - [x] Create route-to-permission mapping
  - [x] Redirect unauthorized users to Dashboard with error message
  - [x] Show toast notification for permission denied
  - [x] Handle edge cases (direct URL access, bookmarks)

- [x] Task 5: Seed Initial Roles with Permissions (AC: 1)
  - [x] Update seed script to create/update Role documents
  - [x] Populate permissions array for each role based on RBAC matrix
  - [x] Ensure Super Admin has all permissions
  - [x] Verify role assignments work with User model

- [x] Task 6: Create API Route for Role Assignment (AC: 1)
  - [x] Create PATCH `/api/v1/users/[id]/role` endpoint
  - [x] Validate role exists before assignment
  - [x] Update user's role reference
  - [x] Return updated user with populated role
  - [x] Protect endpoint with Super Admin permission

- [x] Task 7: Verify all AC met
  - [x] Test role assignment updates permissions correctly
  - [x] Test sidebar shows only permitted menu items per role
  - [x] Test API returns 403 for unauthorized access
  - [x] Test client redirect for unauthorized page access

## Dev Notes

### Relevant Files
- `src/lib/auth/permissions.ts` - Permission constants and role mappings (NEW)
- `src/lib/auth/rbac.ts` - RBAC middleware HOC (NEW)
- `src/lib/auth/index.ts` - Auth module barrel export (UPDATE)
- `src/components/dashboard/sidebar.tsx` - Navigation sidebar (UPDATE)
- `src/proxy.ts` - Route protection proxy (UPDATE)
- `src/app/api/v1/users/[id]/role/route.ts` - Role assignment API (NEW)
- `scripts/seed.ts` - Database seeding script (UPDATE)
[Source: docs/architecture.md#source-tree]

### Data Models

**Role (from Story 1.1):**
- _id: ObjectId (PK)
- name: string (enum: SUPER_ADMIN, DIOCESE_MANAGER, PARISH_PRIEST, ACCOUNTANT, PARISH_SECRETARY)
- permissions: string[] (list of permission codes)
- createdAt: Date

**User (from Story 1.1):**
- _id: ObjectId
- role: ObjectId (ref: Role)
- parish: ObjectId (ref: Parish, for parish-scoped roles)

[Source: docs/architecture.md#data-models]

### RBAC Permissions Matrix

| Permission | SA | DM | PP | ACC | PS |
|------------|----|----|----|----|-----|
| users.* | ✅ | ❌ | ❌ | ❌ | ❌ |
| parishes.write | ✅ | ✅ | ❌ | ❌ | ❌ |
| parishes.read | ✅ | ✅ | ✅ | ✅ | ✅ |
| parishioners.* | ✅ | ✅ | ✅* | ❌ | ✅* |
| transactions.approve | ✅ | ✅ | ❌ | ❌ | ❌ |
| transactions.create | ✅ | ✅ | ✅ | ✅ | ✅ |
| payrolls.approve | ✅ | ✅ | ❌ | ❌ | ❌ |
| payrolls.manage | ✅ | ✅ | ❌ | ✅ | ❌ |
| audit-logs.read | ✅ | ❌ | ❌ | ❌ | ❌ |

*Parish Priest and Parish Secretary are limited to their assigned parish

[Source: docs/architecture.md#security]

### API Endpoints

| Method | Endpoint | Description | Auth | Roles |
|--------|----------|-------------|------|-------|
| PATCH | /users/:id/role | Assign role to user | Yes | SUPER_ADMIN |

[Source: docs/architecture.md#rest-api-spec]

### Middleware Pattern
```typescript
// src/lib/auth/rbac.ts
export function withPermission(permissions: string | string[]) {
  return async (req: NextRequest) => {
    const session = await auth();
    if (!session?.user) {
      return NextResponse.json(
        { success: false, error: { code: 'UNAUTHORIZED', message: 'Chưa đăng nhập' } },
        { status: 401 }
      );
    }

    const userPermissions = session.user.permissions || [];
    const required = Array.isArray(permissions) ? permissions : [permissions];
    const hasAccess = required.some(p => userPermissions.includes(p));

    if (!hasAccess) {
      return NextResponse.json(
        { success: false, error: { code: 'FORBIDDEN', message: 'Không có quyền truy cập' } },
        { status: 403 }
      );
    }

    return null; // Continue to handler
  };
}
```

[Source: docs/architecture.md#components]

### Coding Standards
- **Permission codes:** snake_case with dot notation (e.g., `users.create`, `transactions.approve`)
- **Middleware:** HOC pattern for composable auth checks
- **Error messages:** Vietnamese for user-facing, English for codes
- **Route protection:** Check both API and page level

[Source: docs/architecture.md#coding-standards]

### Previous Story Insights
- Story 1.2 established session with user.permissions array from populated role
- Session user already has: id, email, name, role, roleName, permissions, parish, parishName
- Proxy.ts handles route protection at Edge runtime (Next.js 16)
- Use existing auth() function from `src/lib/auth` for session access

[Source: .ai/stories/1.2.md#dev-record]

## Suggested Skills

Based on this story's requirements, consider using:

- **@senior-fullstack** - Full-stack authorization patterns
  - Use when: Implementing RBAC middleware and permission checks
  - Benefit: Follow best practices for secure authorization

- **@react-best-practices** - React component patterns
  - Use when: Building permission-aware sidebar and navigation
  - Benefit: Optimal component architecture for conditional rendering

- **@api-design-principles** - REST API design
  - Use when: Creating role assignment endpoint
  - Benefit: Consistent error handling and response formats

- **@test-driven-development** - TDD for auth logic
  - Use when: Writing permission checking utilities
  - Benefit: Ensure authorization logic is bulletproof

To use a skill: `*use-skill {skill-name}`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-30 | 1.0 | Initial draft | @executor |
| 2026-01-30 | 1.1 | Story approved | @user |
| 2026-01-30 | 1.2 | Implementation complete, ready for review | @executor |
| 2026-01-30 | 1.3 | Added 68 unit tests, done checklist PASS, status Done | @executor |

## Dev Record

### Agent Model
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Completion Notes
- Created permission utilities with `hasPermission()`, `hasAnyPermission()`, `hasAllPermissions()` functions
- Permission constants and role mappings were already in `models.types.ts` from Story 1.1, re-exported for convenience
- Created RBAC middleware with `withAuth()`, `withPermission()`, `withAllPermissions()`, `withParishScope()` HOCs
- Middleware returns 401 for unauthenticated, 403 for unauthorized access (Vietnamese messages)
- Created `usePermissions()` hook for client-side permission checking
- Sidebar now groups menu items by category (Tổng quan, Quản lý Giáo xứ, Tài chính, Nhân sự, Quản trị, Hệ thống)
- Each nav item has optional `permissions` array for filtering
- Updated proxy.ts to check route permissions and redirect unauthorized users to `/dashboard?error=permission_denied`
- Created PermissionDeniedToast component with sonner for toast notifications
- Created role assignment API endpoint at `PATCH /api/v1/users/[id]/role` (Super Admin only)
- Seed script already seeds roles with permissions (from Story 1.1)
- Build passes with no TypeScript errors (only warnings in pre-existing shadcn components)
- Note: Mongoose shows duplicate index warnings (non-critical, from Story 1.1)

### Test Results
- **68 tests passed** (0 failed)
- Test suites:
  - `permissions.test.ts` - 36 tests (permission utilities, route permissions)
  - `rbac.test.ts` - 13 tests (withAuth, withPermission, withAllPermissions, canManageResource)
  - `use-permissions.test.ts` - 19 tests (hook functionality for all roles)
- Testing infrastructure: Vitest + React Testing Library + jsdom

### File List
**Created:**
- `src/lib/auth/permissions.ts` - Permission utilities and route-permission mapping
- `src/lib/auth/rbac.ts` - RBAC middleware for API routes
- `src/hooks/use-permissions.ts` - Client-side permission hook
- `src/hooks/index.ts` - Hooks barrel export
- `src/components/shared/permission-denied-toast.tsx` - Permission denied toast component
- `src/components/shared/index.ts` - Shared components barrel export
- `src/app/api/v1/users/[id]/role/route.ts` - Role assignment API endpoint
- `vitest.config.ts` - Vitest configuration
- `tests/setup.ts` - Test setup and mocks
- `tests/unit/auth/permissions.test.ts` - Permission utilities tests (36 tests)
- `tests/unit/auth/rbac.test.ts` - RBAC middleware tests (13 tests)
- `tests/unit/hooks/use-permissions.test.ts` - usePermissions hook tests (19 tests)

**Modified:**
- `src/lib/auth/index.ts` - Added permission and RBAC exports
- `src/components/dashboard/sidebar.tsx` - Permission-based navigation with grouped menu items
- `src/proxy.ts` - Route permission checking and redirect logic
- `src/app/layout.tsx` - Added Toaster component from sonner
- `src/app/(dashboard)/layout.tsx` - Added PermissionDeniedToast component
- `package.json` - Added sonner, vitest, testing-library dependencies and test scripts
