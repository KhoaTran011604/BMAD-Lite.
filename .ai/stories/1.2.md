# Story 1.2: Authentication System

**Status:** Done
**Epic:** Epic 1 - Foundation & Authentication
**Created:** 2026-01-30
**Last Updated:** 2026-01-30

## Story

**As a** user,
**I want** to login with email and password,
**so that** I can access the system securely.

## Acceptance Criteria

1. Given valid credentials, When I submit login form, Then I'm authenticated and redirected to dashboard
2. Given invalid credentials, When I submit login form, Then I see appropriate error message
3. Given expired session, When I make request, Then I'm redirected to login page
4. Given logged in user, When I click logout, Then session is invalidated and I'm redirected to login
5. Given login form, When I submit, Then React Hook Form validates with Yup schema

## Tasks

- [x] Task 1: Configure NextAuth.js with Credentials Provider (AC: 1, 2, 3)
  - [x] Install NextAuth.js: `npm install next-auth@beta`
  - [x] Create auth config at `src/lib/auth/auth.config.ts`
  - [x] Setup Credentials provider with email/password
  - [x] Configure JWT strategy with 1-hour expiry
  - [x] Create API route at `src/app/api/auth/[...nextauth]/route.ts`
  - [x] Add NEXTAUTH_SECRET to environment variables

- [x] Task 2: Create Login Page UI (AC: 1, 2, 5)
  - [x] Create login page at `src/app/(auth)/login/page.tsx`
  - [x] Create auth layout at `src/app/(auth)/layout.tsx`
  - [x] Build LoginForm component with shadcn/ui (Input, Button, Form)
  - [x] Integrate React Hook Form with form state
  - [x] Create Yup validation schema for email/password
  - [x] Display validation errors inline

- [x] Task 3: Implement Authentication Logic (AC: 1, 2)
  - [x] Create auth utilities at `src/lib/auth/auth.ts`
  - [x] Implement `verifyCredentials()` function with bcrypt
  - [x] Query User model with role population
  - [x] Return user session data on success
  - [x] Return appropriate error messages on failure

- [x] Task 4: Setup Session Management & Protected Routes (AC: 3)
  - [x] Create auth provider at `src/providers/auth-provider.tsx`
  - [x] Create `useSession` hook wrapper
  - [x] Implement proxy for protected routes at `src/proxy.ts` (Next.js 16)
  - [x] Redirect unauthenticated users to login
  - [x] Handle session expiry gracefully

- [x] Task 5: Implement Logout Functionality (AC: 4)
  - [x] Add logout button to dashboard layout
  - [x] Call NextAuth signOut() on click
  - [x] Clear session and redirect to login
  - [x] Verify session is invalidated

- [x] Task 6: Create Dashboard Placeholder (AC: 1)
  - [x] Create dashboard page at `src/app/(dashboard)/dashboard/page.tsx`
  - [x] Create dashboard layout at `src/app/(dashboard)/layout.tsx`
  - [x] Display logged-in user info
  - [x] Add basic sidebar structure

- [x] Task 7: Verify all AC met
  - [x] Test login with valid credentials → redirects to dashboard ✓
  - [x] Test login with invalid credentials → shows error ✓
  - [x] Test expired session → redirects to login ✓
  - [x] Test logout → clears session, redirects ✓
  - [x] Test form validation → Yup errors display ✓

## Dev Notes

### Relevant Files
- `src/lib/auth/auth.config.ts` - NextAuth configuration
- `src/lib/auth/auth.ts` - NextAuth instance exports
- `src/lib/auth/credentials.ts` - verifyCredentials function + SessionUser type
- `src/lib/auth/index.ts` - Auth module barrel export
- `src/app/api/auth/[...nextauth]/route.ts` - Auth API route
- `src/app/(auth)/login/page.tsx` - Login page
- `src/app/(dashboard)/layout.tsx` - Protected layout
- `src/proxy.ts` - Route protection proxy (Next.js 16)
- `src/providers/auth-provider.tsx` - Session provider
[Source: docs/architecture.md#source-tree]

### Data Models

**User (from Story 1.1):**
- _id: ObjectId
- email: string (unique, required)
- passwordHash: string (bcrypt)
- name: string
- role: ObjectId (ref: Role)
- parish: ObjectId (ref: Parish)
- isActive: boolean
- mustChangePassword: boolean

[Source: docs/architecture.md#data-models]

### API Endpoints

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| POST | /api/auth/callback/credentials | Login | No |
| POST | /api/auth/signout | Logout | Yes |
| GET | /api/auth/session | Get session | Yes |

[Source: docs/architecture.md#rest-api-spec]

### Authentication Flow
```
1. User submits login form
2. NextAuth Credentials provider calls authorize()
3. authorize() calls verifyCredentials()
4. verifyCredentials() queries User, compares bcrypt hash
5. On success: JWT created, session established
6. On failure: Error returned to form
```

[Source: docs/architecture.md#core-workflows]

### Tech Stack for Auth
| Technology | Purpose |
|------------|---------|
| NextAuth.js 5.x | Authentication framework |
| JWT | Token strategy |
| bcrypt | Password hashing |
| React Hook Form | Form management |
| Yup | Validation schema |

[Source: docs/architecture.md#tech-stack]

### Coding Standards
- **Auth config:** `auth.config.ts` (kebab-case)
- **Components:** PascalCase (e.g., `LoginForm`)
- **Hooks:** camelCase with `use` prefix (e.g., `useSession`)
- **Error handling:** Return structured error objects
- **Passwords:** NEVER log or expose in responses

[Source: docs/architecture.md#coding-standards]

### Security Requirements
- JWT stored in httpOnly cookie
- Token expiry: 1 hour
- Password hashing: bcrypt with 12 salt rounds
- Rate limiting: Consider for login endpoint

[Source: docs/architecture.md#security]

### Previous Story Insights
- Story 1.1 creates User model with passwordHash field
- Story 1.1 seeds Super Admin user for testing
- Use the seeded user for login testing

[Source: .ai/stories/1.1.md]

## Suggested Skills

Based on this story's requirements, consider using:

- **@senior-fullstack** - Full-stack authentication patterns
  - Use when: Setting up NextAuth.js configuration
  - Benefit: Follow best practices for auth setup

- **@react-best-practices** - React form handling
  - Use when: Building LoginForm with React Hook Form
  - Benefit: Optimal form state management

- **@test-driven-development** - TDD for auth logic
  - Use when: Writing verifyCredentials function
  - Benefit: Ensure auth logic is correct

- **@systematic-debugging** - Debugging auth issues
  - Use when: Session/token issues arise
  - Benefit: Structured approach to auth debugging

To use a skill: `*use-skill {skill-name}`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-30 | 1.0 | Initial draft | @executor |
| 2026-01-30 | 1.1 | Story approved | @user |
| 2026-01-30 | 1.2 | Implementation complete, ready for review | @executor |
| 2026-01-30 | 1.3 | Review PASS - All AC met, status changed to Done | @reviewer |
| 2026-01-30 | 1.4 | Upgraded to Next.js 16, middleware.ts → proxy.ts, auth module restructured | @executor |

## Dev Record

### Agent Model
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Completion Notes
- Installed NextAuth.js v5 (beta) and Yup for form validation
- Created NextAuth config with Credentials provider and JWT strategy (1-hour expiry)
- Implemented verifyCredentials() function with bcrypt password comparison
- User session includes: id, email, name, role, roleName, permissions, parish, parishName
- Created login page with React Hook Form + Yup validation (Vietnamese messages)
- Dashboard layout with header (user info + logout button) and sidebar navigation
- Proxy (Next.js 16) handles route protection and redirects
- Build passes with no TypeScript errors (only warnings in pre-existing shadcn components)
- Note: Mongoose shows duplicate index warning (non-critical, from Story 1.1)
- **Updated to Next.js 16.1.6** - converted middleware.ts → proxy.ts (Node.js runtime)
- **Auth module restructured** - separated credentials.ts to avoid circular dependency

### File List
**Created:**
- `src/lib/auth/auth.config.ts` - NextAuth configuration with Credentials provider
- `src/lib/auth/auth.ts` - NextAuth instance exports (handlers, auth, signIn, signOut)
- `src/lib/auth/credentials.ts` - verifyCredentials function + SessionUser type
- `src/lib/auth/index.ts` - Auth module barrel export
- `src/app/api/auth/[...nextauth]/route.ts` - NextAuth API route handlers
- `src/lib/validations/auth.schema.ts` - Yup validation schema for login
- `src/app/(auth)/layout.tsx` - Auth pages layout (centered card)
- `src/app/(auth)/login/page.tsx` - Login page
- `src/components/forms/login-form.tsx` - LoginForm component with RHF + Yup
- `src/components/forms/index.ts` - Forms barrel export
- `src/providers/auth-provider.tsx` - NextAuth SessionProvider wrapper
- `src/providers/index.ts` - Providers barrel export
- `src/app/(dashboard)/layout.tsx` - Protected dashboard layout
- `src/app/(dashboard)/dashboard/page.tsx` - Dashboard home page
- `src/components/dashboard/header.tsx` - Dashboard header with user info & logout
- `src/components/dashboard/sidebar.tsx` - Dashboard navigation sidebar
- `src/components/dashboard/index.ts` - Dashboard components barrel export
- `src/proxy.ts` - Route protection proxy (Next.js 16, Node.js runtime)
- `src/types/next-auth.d.ts` - NextAuth type declarations

**Modified:**
- `src/app/layout.tsx` - Added AuthProvider wrapper
- `.env.local` - Added AUTH_SECRET and AUTH_TRUST_HOST
- `package.json` - Next.js 16.1.6, next-auth, yup dependencies
