# Story 1.2: Authentication System

**Status:** Approved
**Epic:** Epic 1 - Foundation & Authentication
**Created:** 2026-01-30
**Last Updated:** 2026-01-30

## Story

**As a** user,
**I want** to login with email and password,
**so that** I can access the system securely.

## Acceptance Criteria

1. Given valid credentials, When I submit login form, Then I'm authenticated and redirected to dashboard
2. Given invalid credentials, When I submit login form, Then I see appropriate error message
3. Given expired session, When I make request, Then I'm redirected to login page
4. Given logged in user, When I click logout, Then session is invalidated and I'm redirected to login
5. Given login form, When I submit, Then React Hook Form validates with Yup schema

## Tasks

- [ ] Task 1: Configure NextAuth.js with Credentials Provider (AC: 1, 2, 3)
  - [ ] Install NextAuth.js: `npm install next-auth@beta`
  - [ ] Create auth config at `src/lib/auth/auth.config.ts`
  - [ ] Setup Credentials provider with email/password
  - [ ] Configure JWT strategy with 1-hour expiry
  - [ ] Create API route at `src/app/api/auth/[...nextauth]/route.ts`
  - [ ] Add NEXTAUTH_SECRET to environment variables

- [ ] Task 2: Create Login Page UI (AC: 1, 2, 5)
  - [ ] Create login page at `src/app/(auth)/login/page.tsx`
  - [ ] Create auth layout at `src/app/(auth)/layout.tsx`
  - [ ] Build LoginForm component with shadcn/ui (Input, Button, Form)
  - [ ] Integrate React Hook Form with form state
  - [ ] Create Yup validation schema for email/password
  - [ ] Display validation errors inline

- [ ] Task 3: Implement Authentication Logic (AC: 1, 2)
  - [ ] Create auth utilities at `src/lib/auth/auth.ts`
  - [ ] Implement `verifyCredentials()` function with bcrypt
  - [ ] Query User model with role population
  - [ ] Return user session data on success
  - [ ] Return appropriate error messages on failure

- [ ] Task 4: Setup Session Management & Protected Routes (AC: 3)
  - [ ] Create auth provider at `src/providers/auth-provider.tsx`
  - [ ] Create `useSession` hook wrapper
  - [ ] Implement middleware for protected routes at `src/middleware.ts`
  - [ ] Redirect unauthenticated users to login
  - [ ] Handle session expiry gracefully

- [ ] Task 5: Implement Logout Functionality (AC: 4)
  - [ ] Add logout button to dashboard layout
  - [ ] Call NextAuth signOut() on click
  - [ ] Clear session and redirect to login
  - [ ] Verify session is invalidated

- [ ] Task 6: Create Dashboard Placeholder (AC: 1)
  - [ ] Create dashboard page at `src/app/(dashboard)/dashboard/page.tsx`
  - [ ] Create dashboard layout at `src/app/(dashboard)/layout.tsx`
  - [ ] Display logged-in user info
  - [ ] Add basic sidebar structure

- [ ] Task 7: Verify all AC met
  - [ ] Test login with valid credentials → redirects to dashboard ✓
  - [ ] Test login with invalid credentials → shows error ✓
  - [ ] Test expired session → redirects to login ✓
  - [ ] Test logout → clears session, redirects ✓
  - [ ] Test form validation → Yup errors display ✓

## Dev Notes

### Relevant Files
- `src/lib/auth/auth.config.ts` - NextAuth configuration
- `src/lib/auth/auth.ts` - Auth utilities
- `src/app/api/auth/[...nextauth]/route.ts` - Auth API route
- `src/app/(auth)/login/page.tsx` - Login page
- `src/app/(dashboard)/layout.tsx` - Protected layout
- `src/middleware.ts` - Route protection middleware
- `src/providers/auth-provider.tsx` - Session provider
[Source: docs/architecture.md#source-tree]

### Data Models

**User (from Story 1.1):**
- _id: ObjectId
- email: string (unique, required)
- passwordHash: string (bcrypt)
- name: string
- role: ObjectId (ref: Role)
- parish: ObjectId (ref: Parish)
- isActive: boolean
- mustChangePassword: boolean

[Source: docs/architecture.md#data-models]

### API Endpoints

| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| POST | /api/auth/callback/credentials | Login | No |
| POST | /api/auth/signout | Logout | Yes |
| GET | /api/auth/session | Get session | Yes |

[Source: docs/architecture.md#rest-api-spec]

### Authentication Flow
```
1. User submits login form
2. NextAuth Credentials provider calls authorize()
3. authorize() calls verifyCredentials()
4. verifyCredentials() queries User, compares bcrypt hash
5. On success: JWT created, session established
6. On failure: Error returned to form
```

[Source: docs/architecture.md#core-workflows]

### Tech Stack for Auth
| Technology | Purpose |
|------------|---------|
| NextAuth.js 5.x | Authentication framework |
| JWT | Token strategy |
| bcrypt | Password hashing |
| React Hook Form | Form management |
| Yup | Validation schema |

[Source: docs/architecture.md#tech-stack]

### Coding Standards
- **Auth config:** `auth.config.ts` (kebab-case)
- **Components:** PascalCase (e.g., `LoginForm`)
- **Hooks:** camelCase with `use` prefix (e.g., `useSession`)
- **Error handling:** Return structured error objects
- **Passwords:** NEVER log or expose in responses

[Source: docs/architecture.md#coding-standards]

### Security Requirements
- JWT stored in httpOnly cookie
- Token expiry: 1 hour
- Password hashing: bcrypt with 12 salt rounds
- Rate limiting: Consider for login endpoint

[Source: docs/architecture.md#security]

### Previous Story Insights
- Story 1.1 creates User model with passwordHash field
- Story 1.1 seeds Super Admin user for testing
- Use the seeded user for login testing

[Source: .ai/stories/1.1.md]

## Suggested Skills

Based on this story's requirements, consider using:

- **@senior-fullstack** - Full-stack authentication patterns
  - Use when: Setting up NextAuth.js configuration
  - Benefit: Follow best practices for auth setup

- **@react-best-practices** - React form handling
  - Use when: Building LoginForm with React Hook Form
  - Benefit: Optimal form state management

- **@test-driven-development** - TDD for auth logic
  - Use when: Writing verifyCredentials function
  - Benefit: Ensure auth logic is correct

- **@systematic-debugging** - Debugging auth issues
  - Use when: Session/token issues arise
  - Benefit: Structured approach to auth debugging

To use a skill: `*use-skill {skill-name}`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-30 | 1.0 | Initial draft | @executor |

## Dev Record

### Agent Model
{To be filled during implementation}

### Completion Notes
{To be filled during implementation}

### File List
**Created:**
{To be filled during implementation}

**Modified:**
{To be filled during implementation}
