# BMAD-Lite Architecture Template
# 100% BMAD-compliant structure with simplified elicitation
template:
  id: architecture-template-v2
  name: Architecture Document
  version: 2.0
  output:
    format: markdown
    filename: docs/architecture.md
    title: "{{project_name}} Architecture Document"

workflow:
  mode: interactive
  approach: pre-populate-and-validate
  elicitation: advanced-elicitation
  requires: docs/prd.md

# ============================================================================
# SECTIONS - 100% BMAD COMPLIANT STRUCTURE
# Section titles MUST match exactly for proper sharding
# ============================================================================
sections:
  # --------------------------------------------------------------------------
  # Section 1: Introduction
  # OUTPUT H2: ## Introduction
  # --------------------------------------------------------------------------
  - id: introduction
    title: Introduction
    required: true
    instruction: |
      BMAD-LITE APPROACH:
      1. Read PRD completely first
      2. PRE-POPULATE introduction based on PRD
      3. Check for starter templates

      OUTPUT FORMAT (EXACT):
      ## Introduction

      This document defines the technical architecture for {{project_name}}.

      **PRD Reference:** docs/prd.md

      ### Starter Template or Existing Project
      {Yes/No - specify if yes, or N/A}

      ### Change Log
      | Date | Version | Description | Author |
      |------|---------|-------------|--------|
      | {today} | 1.0 | Initial architecture | @planner |

    subsections:
      - id: intro-content
        title: null
      - id: starter-template
        title: Starter Template or Existing Project
        elicit: true
      - id: changelog
        title: Change Log
        type: table
        columns: [Date, Version, Description, Author]

  # --------------------------------------------------------------------------
  # Section 2: High Level Architecture
  # OUTPUT H2: ## High Level Architecture
  # --------------------------------------------------------------------------
  - id: high-level-architecture
    title: High Level Architecture
    required: true
    elicit: true
    instruction: |
      BMAD-LITE APPROACH:
      1. PRE-POPULATE based on PRD Technical Assumptions
      2. Present for validation

      OUTPUT FORMAT (EXACT):
      ## High Level Architecture

      ### Technical Summary
      [Brief 3-5 sentence overview of architectural approach]

      ### High Level Overview
      [Describe main architectural style, repository structure, service architecture]

      ### High Level Project Diagram
      ```mermaid
      graph TD
          A[Client] --> B[API Gateway]
          B --> C[Service Layer]
          C --> D[Database]
      ```

      ### Architectural and Design Patterns
      - **Pattern 1:** [Description] - _Rationale:_ [Why]
      - **Pattern 2:** [Description] - _Rationale:_ [Why]

    subsections:
      - id: technical-summary
        title: Technical Summary
      - id: high-level-overview
        title: High Level Overview
      - id: project-diagram
        title: High Level Project Diagram
        type: mermaid
        mermaid_type: graph
      - id: architectural-patterns
        title: Architectural and Design Patterns

  # --------------------------------------------------------------------------
  # Section 3: Tech Stack (CRITICAL - Single Source of Truth)
  # OUTPUT H2: ## Tech Stack
  # --------------------------------------------------------------------------
  - id: tech-stack
    title: Tech Stack
    required: true
    elicit: true
    critical: true
    instruction: |
      CRITICAL: This is the DEFINITIVE technology selection.
      All other documents reference these choices.
      Pin specific versions (avoid "latest").

      BMAD-LITE APPROACH:
      1. Pre-populate from PRD Technical Assumptions
      2. Check tech-preferences.md
      3. Present table for validation
      4. ALL choices must have RATIONALE

      OUTPUT FORMAT (EXACT):
      ## Tech Stack

      ### Cloud Infrastructure
      - **Provider:** {cloud_provider}
      - **Key Services:** {services}
      - **Deployment Regions:** {regions}

      ### Technology Stack Table
      | Category | Technology | Version | Purpose | Rationale |
      |----------|------------|---------|---------|-----------|
      | Language | TypeScript | 5.3.x | Primary language | Type safety, tooling |
      | Runtime | Node.js | 20.x LTS | Server runtime | Stability, ecosystem |
      | Framework | {choice} | {version} | {purpose} | {why} |
      | Database | {choice} | {version} | {purpose} | {why} |
      | Testing | {choice} | {version} | {purpose} | {why} |

    subsections:
      - id: cloud-infrastructure
        title: Cloud Infrastructure
      - id: technology-stack-table
        title: Technology Stack Table
        type: table
        columns: [Category, Technology, Version, Purpose, Rationale]

  # --------------------------------------------------------------------------
  # Section 4: Data Models
  # OUTPUT H2: ## Data Models
  # --------------------------------------------------------------------------
  - id: data-models
    title: Data Models
    required: true
    elicit: true
    repeatable: true
    instruction: |
      BMAD-LITE APPROACH:
      1. Identify entities from PRD requirements
      2. PRE-POPULATE models with key attributes
      3. Present for validation

      OUTPUT FORMAT (EXACT):
      ## Data Models

      ### {EntityName}
      **Purpose:** {What this entity represents}

      **Key Attributes:**
      - id: string (primary key)
      - {attribute}: {type} - {description}
      - createdAt: timestamp
      - updatedAt: timestamp

      **Relationships:**
      - {relationship description}

      ### TypeScript Interfaces
      ```typescript
      interface EntityName {
        id: string;
        // ... attributes
      }
      ```

    subsections:
      - id: model
        title: "{model_name}"
        repeatable: true

  # --------------------------------------------------------------------------
  # Section 5: Components
  # OUTPUT H2: ## Components
  # --------------------------------------------------------------------------
  - id: components
    title: Components
    required: true
    elicit: true
    instruction: |
      BMAD-LITE APPROACH:
      1. Identify components from architecture style
      2. PRE-POPULATE component list
      3. Present for validation

      OUTPUT FORMAT (EXACT):
      ## Components

      ### {ComponentName}
      **Responsibility:** {What this component does}
      **Key Interfaces:** {APIs it exposes}
      **Dependencies:** {Other components it depends on}
      **Technology Stack:** {Specific tech for this component}

      ### Component Diagrams
      ```mermaid
      graph LR
          A[Component A] --> B[Component B]
          B --> C[Database]
      ```

    subsections:
      - id: component-list
        title: "{component_name}"
        repeatable: true
      - id: component-diagrams
        title: Component Diagrams
        type: mermaid

  # --------------------------------------------------------------------------
  # Section 6: External APIs (Conditional)
  # OUTPUT H2: ## External APIs
  # --------------------------------------------------------------------------
  - id: external-apis
    title: External APIs
    required: false
    condition: "Project requires external API integrations"
    elicit: true
    repeatable: true
    instruction: |
      OUTPUT FORMAT (EXACT):
      ## External APIs

      ### {API Name} API
      - **Purpose:** {why needed}
      - **Documentation:** {url}
      - **Base URL(s):** {url}
      - **Authentication:** {method}
      - **Rate Limits:** {limits}

      **Key Endpoints Used:**
      - `GET /endpoint` - {purpose}
      - `POST /endpoint` - {purpose}

      **Integration Notes:** {considerations}

      [If no external APIs: "No external API integrations required."]

  # --------------------------------------------------------------------------
  # Section 7: Core Workflows
  # OUTPUT H2: ## Core Workflows
  # --------------------------------------------------------------------------
  - id: core-workflows
    title: Core Workflows
    required: true
    elicit: true
    instruction: |
      OUTPUT FORMAT (EXACT):
      ## Core Workflows

      ### {Workflow Name}
      [Description of the workflow]

      ```mermaid
      sequenceDiagram
          participant User
          participant API
          participant Service
          participant DB

          User->>API: Request
          API->>Service: Process
          Service->>DB: Query
          DB-->>Service: Result
          Service-->>API: Response
          API-->>User: Result
      ```

  # --------------------------------------------------------------------------
  # Section 8: REST API Spec (Conditional)
  # OUTPUT H2: ## REST API Spec
  # --------------------------------------------------------------------------
  - id: rest-api-spec
    title: REST API Spec
    required: false
    condition: "Project includes REST API"
    elicit: true
    instruction: |
      OUTPUT FORMAT (EXACT):
      ## REST API Spec

      ### API Style
      {REST | GraphQL | tRPC | gRPC}

      ### Base URL
      `/api/v1`

      ### Authentication
      {JWT | Session | OAuth2 | API Key}

      ### Endpoints

      #### {Resource}
      | Method | Endpoint | Description | Auth |
      |--------|----------|-------------|------|
      | GET | /{resource} | List all | Yes |
      | GET | /{resource}/:id | Get one | Yes |
      | POST | /{resource} | Create | Yes |
      | PUT | /{resource}/:id | Update | Yes |
      | DELETE | /{resource}/:id | Delete | Yes |

      ### OpenAPI Specification
      ```yaml
      openapi: 3.0.0
      info:
        title: {API Title}
        version: 1.0.0
      ```

  # --------------------------------------------------------------------------
  # Section 9: Database Schema
  # OUTPUT H2: ## Database Schema
  # --------------------------------------------------------------------------
  - id: database-schema
    title: Database Schema
    required: true
    elicit: true
    instruction: |
      OUTPUT FORMAT (EXACT):
      ## Database Schema

      ### Tables/Collections

      #### {table_name}
      | Column | Type | Constraints | Description |
      |--------|------|-------------|-------------|
      | id | UUID | PK | Primary key |
      | ... | ... | ... | ... |

      ### Indexes
      - {index description}

      ### Entity Relationship Diagram
      ```mermaid
      erDiagram
          User ||--o{ Order : places
          Order ||--|{ OrderItem : contains
      ```

      ### Migrations Strategy
      [How schema changes will be managed]

  # --------------------------------------------------------------------------
  # Section 10: Source Tree
  # OUTPUT H2: ## Source Tree
  # --------------------------------------------------------------------------
  - id: source-tree
    title: Source Tree
    required: true
    elicit: true
    instruction: |
      OUTPUT FORMAT (EXACT):
      ## Source Tree

      ```
      project-root/
      ├── src/
      │   ├── components/      # UI components
      │   ├── services/        # Business logic
      │   ├── models/          # Data models
      │   ├── routes/          # API routes
      │   └── utils/           # Utilities
      ├── tests/
      │   ├── unit/
      │   └── integration/
      ├── docs/
      └── config/
      ```

  # --------------------------------------------------------------------------
  # Section 11: Infrastructure and Deployment
  # OUTPUT H2: ## Infrastructure and Deployment
  # --------------------------------------------------------------------------
  - id: infrastructure-deployment
    title: Infrastructure and Deployment
    required: true
    elicit: true
    instruction: |
      OUTPUT FORMAT (EXACT):
      ## Infrastructure and Deployment

      ### Infrastructure as Code
      - **Tool:** {Terraform | CDK | Pulumi}
      - **Location:** `/infrastructure`
      - **Approach:** {approach}

      ### Deployment Strategy
      - **Strategy:** {Blue-Green | Rolling | Canary}
      - **CI/CD Platform:** {GitHub Actions | GitLab CI | etc.}
      - **Pipeline Configuration:** `.github/workflows/`

      ### Environments
      - **Development:** {description}
      - **Staging:** {description}
      - **Production:** {description}

      ### Environment Promotion Flow
      ```
      Development → Staging → Production
      ```

      ### Rollback Strategy
      - **Primary Method:** {method}
      - **Trigger Conditions:** {triggers}
      - **Recovery Time Objective:** {RTO}

    subsections:
      - id: infrastructure-as-code
        title: Infrastructure as Code
      - id: deployment-strategy
        title: Deployment Strategy
      - id: environments
        title: Environments
        repeatable: true
      - id: promotion-flow
        title: Environment Promotion Flow
      - id: rollback-strategy
        title: Rollback Strategy

  # --------------------------------------------------------------------------
  # Section 12: Error Handling Strategy
  # OUTPUT H2: ## Error Handling Strategy
  # --------------------------------------------------------------------------
  - id: error-handling-strategy
    title: Error Handling Strategy
    required: true
    elicit: true
    instruction: |
      OUTPUT FORMAT (EXACT):
      ## Error Handling Strategy

      ### General Approach
      - **Error Model:** {model}
      - **Exception Hierarchy:** {structure}
      - **Error Propagation:** {rules}

      ### Logging Standards
      - **Library:** {library}
      - **Format:** {JSON structured | text}
      - **Levels:** {DEBUG, INFO, WARN, ERROR}
      - **Required Context:** Correlation ID, Service, User

      ### Error Handling Patterns

      #### External API Errors
      - **Retry Policy:** {strategy}
      - **Circuit Breaker:** {config}
      - **Timeout Configuration:** {settings}

      #### Business Logic Errors
      - **Custom Exceptions:** {types}
      - **User-Facing Errors:** {format}
      - **Error Codes:** {system}

      #### Data Consistency
      - **Transaction Strategy:** {approach}
      - **Idempotency:** {approach}

    subsections:
      - id: general-approach
        title: General Approach
      - id: logging-standards
        title: Logging Standards
      - id: error-patterns
        title: Error Handling Patterns

  # --------------------------------------------------------------------------
  # Section 13: Coding Standards
  # OUTPUT H2: ## Coding Standards
  # --------------------------------------------------------------------------
  - id: coding-standards
    title: Coding Standards
    required: true
    elicit: true
    instruction: |
      CRITICAL: These are directives for AI agents.
      Keep MINIMAL but essential.

      OUTPUT FORMAT (EXACT):
      ## Coding Standards

      ### Core Standards
      - **Languages & Runtimes:** {versions}
      - **Style & Linting:** ESLint + Prettier
      - **Test Organization:** {convention}

      ### Naming Conventions
      | Element | Convention | Example |
      |---------|------------|---------|
      | Files | kebab-case | user-service.ts |
      | Components | PascalCase | UserProfile.tsx |
      | Functions | camelCase | getUserById |

      ### Critical Rules
      - **Rule 1:** {description}
      - **Rule 2:** {description}

      ### Language-Specific Guidelines
      [Only if critical for preventing AI mistakes]

    subsections:
      - id: core-standards
        title: Core Standards
      - id: naming-conventions
        title: Naming Conventions
        type: table
        columns: [Element, Convention, Example]
      - id: critical-rules
        title: Critical Rules
        repeatable: true
      - id: language-specifics
        title: Language-Specific Guidelines
        condition: "Critical language-specific rules needed"

  # --------------------------------------------------------------------------
  # Section 14: Test Strategy and Standards
  # OUTPUT H2: ## Test Strategy and Standards
  # --------------------------------------------------------------------------
  - id: test-strategy
    title: Test Strategy and Standards
    required: true
    elicit: true
    instruction: |
      OUTPUT FORMAT (EXACT):
      ## Test Strategy and Standards

      ### Testing Philosophy
      - **Approach:** {TDD | Test-After | BDD}
      - **Coverage Goals:** {targets}
      - **Test Pyramid:** {distribution}

      ### Test Types and Organization

      #### Unit Tests
      - **Framework:** {framework}
      - **File Convention:** `*.test.ts` / `*.spec.ts`
      - **Location:** alongside source / `tests/unit/`
      - **Mocking Library:** {library}
      - **Coverage Requirement:** {percentage}

      #### Integration Tests
      - **Scope:** {what's covered}
      - **Location:** `tests/integration/`
      - **Test Infrastructure:** {approach}

      #### End-to-End Tests
      - **Framework:** {framework}
      - **Scope:** {critical paths}
      - **Environment:** {where run}

      ### Test Data Management
      - **Strategy:** {approach}
      - **Fixtures:** {location}
      - **Cleanup:** {strategy}

      ### Continuous Testing
      - **CI Integration:** {stages}
      - **Performance Tests:** {approach}
      - **Security Tests:** {approach}

    subsections:
      - id: testing-philosophy
        title: Testing Philosophy
      - id: test-types
        title: Test Types and Organization
      - id: test-data-management
        title: Test Data Management
      - id: continuous-testing
        title: Continuous Testing

  # --------------------------------------------------------------------------
  # Section 15: Security
  # OUTPUT H2: ## Security
  # --------------------------------------------------------------------------
  - id: security
    title: Security
    required: true
    elicit: true
    critical: true
    instruction: |
      CRITICAL: Security must be addressed.

      OUTPUT FORMAT (EXACT):
      ## Security

      ### Input Validation
      - **Validation Library:** {library}
      - **Validation Location:** API boundary
      - **Required Rules:** whitelist approach, sanitize inputs

      ### Authentication & Authorization
      - **Auth Method:** {JWT | Session | OAuth2}
      - **Session Management:** {approach}
      - **Required Patterns:** {patterns}

      ### Secrets Management
      - **Development:** .env files (git-ignored)
      - **Production:** {secrets service}
      - **Code Requirements:** NEVER hardcode secrets

      ### API Security
      - **Rate Limiting:** {implementation}
      - **CORS Policy:** {configuration}
      - **Security Headers:** {required headers}
      - **HTTPS Enforcement:** Required

      ### Data Protection
      - **Encryption at Rest:** {approach}
      - **Encryption in Transit:** TLS 1.3
      - **PII Handling:** {rules}
      - **Logging Restrictions:** {what not to log}

      ### Dependency Security
      - **Scanning Tool:** {tool}
      - **Update Policy:** {frequency}

      ### Security Testing
      - **SAST Tool:** {tool}
      - **DAST Tool:** {tool}

    subsections:
      - id: input-validation
        title: Input Validation
      - id: auth-authorization
        title: Authentication & Authorization
      - id: secrets-management
        title: Secrets Management
      - id: api-security
        title: API Security
      - id: data-protection
        title: Data Protection
      - id: dependency-security
        title: Dependency Security
      - id: security-testing
        title: Security Testing

  # --------------------------------------------------------------------------
  # Section 16: Checklist Results Report
  # OUTPUT H2: ## Checklist Results Report
  # --------------------------------------------------------------------------
  - id: checklist-results
    title: Checklist Results Report
    required: false
    instruction: |
      OUTPUT FORMAT (EXACT):
      ## Checklist Results Report

      [Results from architect-checklist.md execution]
      [Or "Skipped"]

  # --------------------------------------------------------------------------
  # Section 17: Next Steps
  # OUTPUT H2: ## Next Steps
  # --------------------------------------------------------------------------
  - id: next-steps
    title: Next Steps
    required: true
    instruction: |
      OUTPUT FORMAT (EXACT):
      ## Next Steps

      Architecture complete. To begin development:

      ### Frontend Architecture (if applicable)
      [If project has UI: prompt for frontend architecture]

      ### Development
      1. Run `@executor draft-story` to create first story
      2. Stories will reference this architecture document
      3. Track progress in `.ai/progress.md`
